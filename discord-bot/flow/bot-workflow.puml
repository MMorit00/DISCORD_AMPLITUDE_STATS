@startuml BotWorkflow
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"

title Discord Bot 交互流程

actor "用户" as User
participant "Discord\nGateway" as Gateway
participant "Bot\n主程序" as Bot
participant "LLM\nHandler" as LLM
participant "Function\nExecutor" as Executor
participant "GitHub\nSync" as GitHub
database "transactions.csv" as DB

' ============================================================
' 流程1: 自然语言交互
' ============================================================

User -> Gateway: "今天没定投 018043"
activate Gateway

Gateway -> Bot: 消息事件
activate Bot

Bot -> Bot: 权限校验\n(ALLOWED_USER_IDS)

Bot -> LLM: parse_message()
activate LLM

LLM -> LLM: Qwen API\n(新加坡端点)
note right: Function Calling\nskip_investment(\n  date="today",\n  fund_code="018043"\n)

LLM --> Bot: 函数名 + 参数
deactivate LLM

Bot -> Executor: execute()
activate Executor

Executor -> GitHub: skip_transaction()
activate GitHub

GitHub -> DB: 读取文件\n(获取 SHA)
GitHub -> DB: 修改 type=skip\nstatus=skipped
GitHub -> DB: 写入\n(If-Match)
GitHub -> GitHub: Commit\n[bot] skip_investment

GitHub --> Executor: 成功
deactivate GitHub

Executor --> Bot: success=True
deactivate Executor

Bot -> Gateway: reply()
Gateway -> User: "✅ 已标记 2025-10-28 的\n018043 为'未定投'"

deactivate Bot
deactivate Gateway

' ============================================================
' 流程2: 命令模式
' ============================================================

User -> Gateway: "!status"
activate Gateway

Gateway -> Bot: 命令
activate Bot

Bot -> Executor: query_status()
activate Executor

Executor -> GitHub: read_holdings()
activate GitHub

GitHub -> DB: 读取 holdings.json
GitHub --> Executor: 持仓数据
deactivate GitHub

Executor --> Bot: 格式化结果
deactivate Executor

Bot -> Gateway: reply()
Gateway -> User: "💰 总市值: ¥8,144.31\n📊 权重分布:..."

deactivate Bot
deactivate Gateway

@enduml

