@startuml BotWorkflow
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"

title Discord Bot äº¤äº’æµç¨‹

actor "ç”¨æˆ·" as User
participant "Discord\nGateway" as Gateway
participant "Bot\nä¸»ç¨‹åº" as Bot
participant "LLM\nHandler" as LLM
participant "Function\nExecutor" as Executor
participant "GitHub\nSync" as GitHub
database "transactions.csv" as DB

' ============================================================
' æµç¨‹1: è‡ªç„¶è¯­è¨€äº¤äº’
' ============================================================

User -> Gateway: "ä»Šå¤©æ²¡å®šæŠ• 018043"
activate Gateway

Gateway -> Bot: æ¶ˆæ¯äº‹ä»¶
activate Bot

Bot -> Bot: æƒé™æ ¡éªŒ\n(ALLOWED_USER_IDS)

Bot -> LLM: parse_message()
activate LLM

LLM -> LLM: Qwen API\n(æ–°åŠ å¡ç«¯ç‚¹)
note right: Function Calling\nskip_investment(\n  date="today",\n  fund_code="018043"\n)

LLM --> Bot: å‡½æ•°å + å‚æ•°
deactivate LLM

Bot -> Executor: execute()
activate Executor

Executor -> GitHub: skip_transaction()
activate GitHub

GitHub -> DB: è¯»å–æ–‡ä»¶\n(è·å– SHA)
GitHub -> DB: ä¿®æ”¹ type=skip\nstatus=skipped
GitHub -> DB: å†™å…¥\n(If-Match)
GitHub -> GitHub: Commit\n[bot] skip_investment

GitHub --> Executor: æˆåŠŸ
deactivate GitHub

Executor --> Bot: success=True
deactivate Executor

Bot -> Gateway: reply()
Gateway -> User: "âœ… å·²æ ‡è®° 2025-10-28 çš„\n018043 ä¸º'æœªå®šæŠ•'"

deactivate Bot
deactivate Gateway

' ============================================================
' æµç¨‹2: å‘½ä»¤æ¨¡å¼
' ============================================================

User -> Gateway: "!status"
activate Gateway

Gateway -> Bot: å‘½ä»¤
activate Bot

Bot -> Executor: query_status()
activate Executor

Executor -> GitHub: read_holdings()
activate GitHub

GitHub -> DB: è¯»å– holdings.json
GitHub --> Executor: æŒä»“æ•°æ®
deactivate GitHub

Executor --> Bot: æ ¼å¼åŒ–ç»“æœ
deactivate Executor

Bot -> Gateway: reply()
Gateway -> User: "ğŸ’° æ€»å¸‚å€¼: Â¥8,144.31\nğŸ“Š æƒé‡åˆ†å¸ƒ:..."

deactivate Bot
deactivate Gateway

@enduml

