@startuml GitHubSync
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"

title GitHub 幂等写入流程

participant "Function\nExecutor" as Executor
participant "GitHub\nSync" as Sync
participant "GitHub API" as API
database "transactions.csv" as DB

' ============================================================
' 幂等写入流程
' ============================================================

Executor -> Sync: skip_transaction(\n  fund_code="018043",\n  date="2025-10-28"\n)
activate Sync

Sync -> API: get_contents(\n  "portfolio-report/data/\n  transactions.csv"\n)
activate API

API --> Sync: content + SHA
deactivate API

note over Sync: SHA = "abc123"\n用于 If-Match

Sync -> Sync: 解析 CSV
Sync -> Sync: 找到目标行\n修改 type=skip\nstatus=skipped

Sync -> Sync: 生成事务 ID\ntx_id = uuid[:8]

Sync -> API: update_file(\n  path=...,\n  content=new_csv,\n  message="[bot] skip...[tx:1a2b]",\n  sha="abc123"\n)
activate API

alt 成功
    API --> Sync: commit_sha
    note right: ✅ If-Match 通过\n写入成功
    
else 并发冲突 (409)
    API --> Sync: 409 Conflict
    note right: ❌ SHA 不匹配\n有其他写入
    
    Sync -> API: get_contents()\n重新读取
    API --> Sync: new_content + new_SHA
    
    Sync -> Sync: 重新应用修改
    
    Sync -> API: update_file(\n  sha=new_SHA\n)
    API --> Sync: commit_sha
    note right: ✅ 重试成功
end

deactivate API

Sync --> Executor: success=True,\ncommit_sha=...,\ntx_id=...
deactivate Sync

note over Executor: ✅ 幂等性保证\n事务 ID 唯一\n可重复执行

@enduml

