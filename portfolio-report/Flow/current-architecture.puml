@startuml CurrentArchitecture
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"
skinparam linetype ortho

title Portfolio Report - å½“å‰å·²å®ç°æ¶æ„ (v0.2)

' æ ·å¼å®šä¹‰
skinparam component {
  BackgroundColor<<core>> #C8E6C9
  BorderColor<<core>> #4CAF50
  BackgroundColor<<source>> #FFE0B2
  BorderColor<<source>> #FF9800
  BackgroundColor<<util>> #BBDEFB
  BorderColor<<util>> #2196F3
  BackgroundColor<<report>> #E1BEE7
  BorderColor<<report>> #9C27B0
  FontSize 14
}

skinparam database {
  BackgroundColor #FFF9C4
  BorderColor #FBC02D
}

skinparam cloud {
  BackgroundColor #E0F2F1
  BorderColor #009688
}

' ============================================================
' æ•°æ®å±‚
' ============================================================

database "transactions.csv" as TxDB
database "holdings.json" as HoldingsDB  
database "state.json" as StateDB
database "config.yaml" as ConfigDB
database "cache/" as CacheDB

' ============================================================
' æ ¸å¿ƒä¸šåŠ¡å±‚
' ============================================================

package "Core Business" {
  [TradingCalendar\näº¤æ˜“æ—¥å†] as Calendar <<core>>
  [Portfolio\næŒä»“ç®¡ç†] as Portfolio <<core>>
  [Metrics\næ”¶ç›ŠæŒ‡æ ‡] as Metrics <<core>>
  [Signals\nä¿¡å·å¼•æ“] as Signals <<core>>
  [ConfirmPoller\nç¡®è®¤è½®è¯¢] as ConfirmPoller <<core>>
}

' ============================================================
' æ•°æ®æºå±‚
' ============================================================

package "Data Source" {
  [EastMoneyAPI\nä¸œæ–¹è´¢å¯Œ] as EastMoney <<source>>
}

' ============================================================
' æŠ¥å‘Šå±‚
' ============================================================

package "Report Layer" {
  [ReportBuilder\næŠ¥å‘Šç”Ÿæˆ] as ReportBuilder <<report>>
  [CLI\nmain.py] as CLI <<report>>
}

' ============================================================
' å·¥å…·å±‚
' ============================================================

package "Utils" {
  [ConfigLoader\né…ç½®åŠ è½½] as ConfigLoader <<util>>
  [Discord\nWebhookæ¨é€] as Discord <<util>>
}

' ============================================================
' å¤–éƒ¨æœåŠ¡
' ============================================================

cloud "å¤©å¤©åŸºé‡‘ API" as TianTian
cloud "ä¸œæ–¹è´¢å¯Œ API" as EastMoneyCloud
cloud "Discord Webhook" as DiscordWebhook
cloud "GitHub Actions\nå®šæ—¶è§¦å‘" as GHActions
cloud "cron-job.org\nå¤–éƒ¨å®šæ—¶" as CronJob

' ============================================================
' å…³ç³»ï¼šæ ¸å¿ƒæµç¨‹
' ============================================================

Portfolio *-- Calendar : ä½¿ç”¨
Portfolio --> ConfigLoader : è¯»å–é…ç½®
Portfolio --> EastMoney : è·å–å‡€å€¼
Portfolio --> Metrics : è®¡ç®—æ”¶ç›Š

Signals --> Portfolio : è¯»å–æƒé‡
Signals --> Metrics : è¯»å–æŒ‡æ ‡
Signals --> StateDB : å†·å´çŠ¶æ€

ConfirmPoller --> Portfolio : ä¾èµ–
ConfirmPoller --> EastMoney : æ£€æŸ¥å‡€å€¼

' ============================================================
' å…³ç³»ï¼šæ•°æ®å±‚
' ============================================================

Portfolio --> TxDB : è¯»å–äº¤æ˜“
Portfolio --> HoldingsDB : ä¿å­˜å¿«ç…§
ConfirmPoller --> TxDB : å›å¡«ç¡®è®¤

ConfigLoader --> ConfigDB : è¯»å–
EastMoney --> CacheDB : ç¼“å­˜

' ============================================================
' å…³ç³»ï¼šæŠ¥å‘Šå±‚
' ============================================================

ReportBuilder --> Portfolio : è¯»å–æŒä»“
ReportBuilder --> Signals : è¯»å–ä¿¡å·
ReportBuilder --> Discord : æ¨é€æŠ¥å‘Š

CLI --> ReportBuilder : ç”ŸæˆæŠ¥å‘Š
CLI --> Calendar : åˆ¤å®šäº¤æ˜“æ—¥
CLI --> Portfolio : åˆ·æ–°æ•°æ®
CLI --> Signals : ç”Ÿæˆä¿¡å·

' ============================================================
' å…³ç³»ï¼šæ•°æ®æº
' ============================================================

EastMoney --> TianTian : ä¼°å€¼
EastMoney --> EastMoneyCloud : å‡€å€¼

' ============================================================
' å…³ç³»ï¼šéƒ¨ç½²å±‚
' ============================================================

CronJob --> GHActions : è§¦å‘ workflow_dispatch
GHActions --> CLI : è¿è¡ŒæŠ¥å‘Š
GHActions --> ConfirmPoller : è¿è¡Œè½®è¯¢

ReportBuilder --> DiscordWebhook : æ¨é€
ConfirmPoller --> DiscordWebhook : é€šçŸ¥

' ============================================================
' æ ¸å¿ƒæµç¨‹
' ============================================================

note as Flow
  <b>å®Œæ•´æµç¨‹</b>
  â”â”â”â”â”â”â”â”â”â”â”â”
  1. cron è§¦å‘ Actions
  2. è¯»å–äº¤æ˜“è®°å½•
  3. æ„å»ºæŒä»“
  4. è·å–å‡€å€¼/ä¼°å€¼
  5. è®¡ç®—æƒé‡
  6. ç”Ÿæˆä¿¡å·
  7. ç”ŸæˆæŠ¥å‘Š
  8. æ¨é€ Discord
end note

Flow -[hidden]- Portfolio

' ============================================================
' å›¾ä¾‹
' ============================================================

legend right
  |= å·²å®ç°æ¨¡å— (v0.2) |
  | TradingCalendar | 340è¡Œ âœ… |
  | Portfolio | 361è¡Œ âœ… |
  | EastMoneyAPI | 376è¡Œ âœ… |
  | Metrics | 174è¡Œ âœ… |
  | Signals | 427è¡Œ âœ… |
  | ReportBuilder | 233è¡Œ âœ… |
  | CLI (main.py) | 165è¡Œ âœ… |
  | ConfirmPoller | 238è¡Œ âœ… |
  
  |= GitHub Actions |
  | daily.yml | âœ… |
  | weekly.yml | âœ… |
  | monthly.yml | âœ… |
  | confirm-poll.yml | âœ… |
  
  |= æ ¸å¿ƒç‰¹æ€§ |
  | 15:00 cutoff | âœ… |
  | ä¼°/å‡€å¹¶è¡Œ | âœ… |
  | T+N ç¡®è®¤ | âœ… |
  | æƒé‡åˆ†æ | âœ… |
  | ä¿¡å·å¼•æ“ | âœ… |
  | è‡ªåŠ¨æŠ¥å‘Š | âœ… |
  | ç¡®è®¤å›å¡« | âœ… |
  
  |= å¾…å®ç° (TODO) |
  | Discord Bot | ğŸš§ |
  | LLM äº¤äº’ | ğŸš§ |
  | GitHub å¹‚ç­‰å†™å…¥ | ğŸš§ |
endlegend

@enduml
