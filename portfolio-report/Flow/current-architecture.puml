@startuml CurrentArchitecture
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"
skinparam linetype ortho

title Portfolio Report - 当前已实现架构 (v0.1)

' 样式定义
skinparam component {
  BackgroundColor<<core>> #C8E6C9
  BorderColor<<core>> #4CAF50
  BackgroundColor<<source>> #FFE0B2
  BorderColor<<source>> #FF9800
  BackgroundColor<<util>> #BBDEFB
  BorderColor<<util>> #2196F3
  FontSize 14
}

skinparam database {
  BackgroundColor #FFF9C4
  BorderColor #FBC02D
}

' ============================================================
' 数据层
' ============================================================

database "transactions.csv" as TxDB
database "holdings.json" as HoldingsDB  
database "config.yaml" as ConfigDB
database "cache/" as CacheDB

' ============================================================
' 核心业务层
' ============================================================

package "Core Business" {
  [TradingCalendar\n交易日历] as Calendar <<core>>
  [Portfolio\n持仓管理] as Portfolio <<core>>
  [Position\n单个持仓] as Position <<core>>
}

' ============================================================
' 数据源层
' ============================================================

package "Data Source" {
  [EastMoneyAPI\n东方财富] as EastMoney <<source>>
}

' ============================================================
' 工具层
' ============================================================

package "Utils" {
  [ConfigLoader\n配置加载] as ConfigLoader <<util>>
  [Discord\nWebhook推送] as Discord <<util>>
}

' ============================================================
' 外部服务
' ============================================================

cloud "天天基金 API" as TianTian
cloud "东方财富 API" as EastMoneyCloud

' ============================================================
' 关系：核心流程
' ============================================================

Portfolio *-- Position : 持有多个
Portfolio *-- Calendar : 使用
Portfolio --> ConfigLoader : 读取配置
Portfolio --> EastMoney : 获取净值

' ============================================================
' 关系：数据层
' ============================================================

Portfolio --> TxDB : 读取交易
Portfolio --> HoldingsDB : 保存快照

ConfigLoader --> ConfigDB : 读取
EastMoney --> CacheDB : 缓存

' ============================================================
' 关系：数据源
' ============================================================

EastMoney --> TianTian : 估值
EastMoney --> EastMoneyCloud : 净值

' ============================================================
' 核心流程（简化版）
' ============================================================

note as Flow
  <b>核心流程</b>
  ━━━━━━━━━━━━
  1. 读取交易记录
  2. 构建持仓
  3. 获取净值/估值
  4. 计算权重
  5. 保存快照
end note

Flow -[hidden]- Portfolio

' ============================================================
' 图例
' ============================================================

legend right
  |= 已实现模块 |
  | TradingCalendar | 340行 |
  | Portfolio | 361行 |
  | EastMoneyAPI | 376行 |
  | ConfigLoader | 93行 |
  
  |= 核心特性 |
  | 15:00 cutoff | ✅ |
  | 估/净并行 | ✅ |
  | T+N 确认 | ✅ |
  | 权重分析 | ✅ |
endlegend

@enduml
