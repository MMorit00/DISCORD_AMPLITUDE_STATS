@startuml CurrentArchitecture
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"
skinparam linetype ortho

title Portfolio Report - 已实现架构 (v0.2)

' 样式定义
skinparam component {
  BackgroundColor<<core>> #C8E6C9
  BorderColor<<core>> #4CAF50
  BackgroundColor<<source>> #FFE0B2
  BorderColor<<source>> #FF9800
  BackgroundColor<<report>> #E1BEE7
  BorderColor<<report>> #9C27B0
  FontSize 14
}

skinparam database {
  BackgroundColor #FFF9C4
  BorderColor #FBC02D
}

skinparam cloud {
  BackgroundColor #E0F2F1
  BorderColor #009688
}

' ============================================================
' 核心模块
' ============================================================

[Portfolio\n持仓管理] as Portfolio <<core>>
[Signals\n信号引擎] as Signals <<core>>
[ReportBuilder\n报告生成] as ReportBuilder <<report>>
[EastMoneyAPI\n数据源] as EastMoney <<source>>

' ============================================================
' 数据与服务
' ============================================================

database "transactions.csv" as TxDB
database "holdings.json" as HoldingsDB  
database "state.json" as StateDB

cloud "天天基金/东方财富" as API
cloud "Discord" as Discord
cloud "GitHub Actions\n(cron触发)" as GHActions

' ============================================================
' 核心关系
' ============================================================

Portfolio --> TxDB : 读取
Portfolio --> EastMoney : 净值
Portfolio --> HoldingsDB : 保存

Signals --> Portfolio : 权重
Signals --> StateDB : 冷却

ReportBuilder --> Portfolio : 持仓
ReportBuilder --> Signals : 信号
ReportBuilder --> Discord : 推送

EastMoney --> API : 抓取

GHActions --> Portfolio : 触发
GHActions --> ReportBuilder : 生成

' ============================================================
' 流程
' ============================================================

note as Flow
  <b>核心流程</b>
  ━━━━━━━━━━
  1. 读取交易
  2. 获取净值
  3. 计算权重
  4. 生成信号
  5. 推送报告
end note

Flow -[hidden]- Portfolio

' ============================================================
' 图例
' ============================================================

legend right
  |= 核心模块 (8个) |
  | Portfolio | 361行 ✅ |
  | Signals | 427行 ✅ |
  | ReportBuilder | 233行 ✅ |
  | EastMoneyAPI | 376行 ✅ |
  | TradingCalendar | 340行 ✅ |
  | Metrics | 174行 ✅ |
  | ConfirmPoller | 238行 ✅ |
  | CLI | 165行 ✅ |
  
  |= 特性 |
  | 估/净并行 | ✅ |
  | 信号引擎 | ✅ |
  | 自动报告 | ✅ |
  | 确认回填 | ✅ |
  
  |= 待实现 |
  | Discord Bot | 🚧 |
endlegend

@enduml
