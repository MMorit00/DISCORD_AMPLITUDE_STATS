@startuml Toz_demo核心架构
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"
skinparam linetype ortho

title Toz_demo - ViewModel 层架构（重构后）

' 样式定义
skinparam component {
  BackgroundColor<<viewmodel>> #FFE0B2
  BorderColor<<viewmodel>> #FF9800
  FontSize 14
}

skinparam arrow {
  FontSize 10
}

' ============================================================
' ViewModel 层
' ============================================================

package "ViewModel Layer" {
  
  [TozModel\n组合根] as TozModel <<viewmodel>>
  
  [MIDIModel\nMIDI播放器] as MIDIModel <<viewmodel>>
  
  [TimelineModel\n时间轴UI] as TimelineModel <<viewmodel>>
  
  [GridStateManager\n网格状态] as GridStateManager <<viewmodel>>
  
  ' ============================================================
  ' 组合关系
  ' ============================================================
  
  TozModel *-- MIDIModel
  TozModel *-- GridStateManager
  MIDIModel *-- TimelineModel
  
  ' ============================================================
  ' 数据流
  ' ============================================================
  
  TimelineModel -up-> MIDIModel : 订阅
  MIDIModel -down-> GridStateManager : 推送
  TozModel -down-> GridStateManager : 推送
  GridStateManager .up.> TozModel : 闭包
  
  ' ============================================================
  ' objectWillChange 转发
  ' ============================================================
  
  TimelineModel -[#FF0000,dashed]-> MIDIModel : 转发
  MIDIModel -[#FF0000,dashed]-> TozModel : 转发
}

' ============================================================
' 图例
' ============================================================

legend right
  |= 关系 |
  | *-- | 组合 |
  | --> | Combine |
  | ..> | 闭包 |
  | <color:red>--></color> | 转发 |
  
  |= 改进 |
  | ✅ | 组合根集中装配 |
  | ✅ | 消除领域穿透 |
  | ✅ | 单向数据流 |
endlegend

@enduml
