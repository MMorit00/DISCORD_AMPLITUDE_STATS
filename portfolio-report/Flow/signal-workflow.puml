@startuml æˆ˜æœ¯ä¿¡å·è§¦å‘æµç¨‹ï¼ˆæœªçŸ¥ä»·åŽŸåˆ™ï¼‰
skinparam backgroundColor white
skinparam defaultFontName "PingFang SC,Microsoft YaHei,SimHei,Arial Unicode MS"

title æˆ˜æœ¯ä¿¡å·è§¦å‘æµç¨‹ï¼ˆæœªçŸ¥ä»·åŽŸåˆ™ + 15:00 Cutoffï¼‰

autonumber

' å‚ä¸Žè€…
actor "ç”¨æˆ·" as User
participant "GitHub Actions\nå®šæ—¶ä»»åŠ¡" as Actions
participant "Portfolio\næŒä»“ç®¡ç†" as Portfolio
participant "EastMoneyAPI\næ•°æ®æº" as API
participant "Signals\nä¿¡å·å¼•æ“Ž" as Signals
participant "Discord Webhook" as Discord
participant "Discord Bot\nå¸¸é©»ç›‘å¬" as Bot
database "transactions.csv" as DB

' ============================================================
' Aè‚¡ä¿¡å·æµç¨‹ï¼ˆå½“æ—¥ç›˜ä¸­æ•°æ®ï¼‰
' ============================================================

group Aè‚¡ä¿¡å·æµç¨‹ï¼ˆ14:40 è§¦å‘ï¼‰
  
  Actions -> Actions : 14:40 CST å®šæ—¶è§¦å‘
  Actions -> Portfolio : refresh(prefer_estimate=True)
  
  Portfolio -> API : get_nav_or_estimate(000051)
  API --> Portfolio : ä¼°å€¼æ•°æ®ï¼ˆç›˜ä¸­ï¼‰
  
  Portfolio -> Portfolio : calculate_weights()
  Portfolio --> Actions : æƒé‡(ä¼°): 83.42%
  
  Actions -> Signals : check_tactical_signals()
  
  alt è§¦å‘æˆ˜æœ¯ä¿¡å·
    Signals -> Signals : åˆ¤å®šï¼šå›žæ’¤â‰¥10% æˆ– è¶…é¢>15%
    Signals --> Actions : ä¿¡å·ï¼šåŠ ä»“ 100å…ƒ
    
    Actions -> Discord : æŽ¨é€ç¡®è®¤æ¶ˆæ¯
    note right
      **âš ï¸ Aè‚¡æˆ˜æœ¯æé†’**
      
      æ²ªæ·±300è”æŽ¥(000051)
      â€¢ å›žæ’¤ï¼š12.5%ï¼ˆè§¦å‘åŠ ä»“ï¼‰
      â€¢ å»ºè®®åŠ ç ï¼š100å…ƒ
      â€¢ æˆªæ­¢æ—¶é—´ï¼š**15:00**
      â€¢ æˆäº¤ä»·ï¼šæŒ‰å½“æ—¥æ”¶ç›˜å‡€å€¼ï¼ˆTæ—¥æœªçŸ¥ä»·ï¼‰
      
      **å›žå¤ âœ… ç¡®è®¤æ‰§è¡Œ | âŒ å–æ¶ˆ**
    end note
    
    Discord --> User : æ˜¾ç¤ºæ¶ˆæ¯
    
    User -> Bot : å›žå¤ "âœ…"
    Bot -> Bot : LLMè§£æžæ„å›¾
    Bot -> DB : å†™å…¥äº¤æ˜“è®°å½•ï¼ˆstatus=pendingï¼‰
    Bot -> Discord : ç¡®è®¤å·²è®°å½•ï¼Œç­‰å¾… 15:00 å‰æäº¤
    
    alt 15:00 å‰ç¡®è®¤
      Bot -> DB : æ›´æ–° cutoff_flag=pre15, trade_day_cn=T
      Bot -> Discord : âœ… å·²æäº¤ï¼Œé¢„è®¡ T+1 ç¡®è®¤
    else 15:00 åŽ
      Bot -> DB : æ›´æ–° cutoff_flag=post15, trade_day_cn=T+1
      Bot -> Discord : âš ï¸ é€¾æœŸï¼Œé¡ºå»¶è‡³ä¸‹ä¸€äº¤æ˜“æ—¥
    end
    
  else æœªè§¦å‘
    Signals --> Actions : æ— ä¿¡å·
  end
  
end

' ============================================================
' QDII ä¿¡å·æµç¨‹ï¼ˆæ˜¨å¤œæ”¶ç›˜æ•°æ®ï¼‰
' ============================================================

group QDIIä¿¡å·æµç¨‹ï¼ˆ07:30 + 14:40 åŒæŽ¨é€ï¼‰
  
  == 07:30 æ™¨é—´æŽ¨é€ ==
  
  Actions -> Actions : 07:30 CST å®šæ—¶è§¦å‘
  Actions -> Portfolio : refresh(prefer_estimate=False)
  
  Portfolio -> API : get_latest_nav(018043)
  API --> Portfolio : å‡€å€¼æ•°æ®ï¼ˆæ˜¨å¤œæ”¶ç›˜ï¼‰
  
  Portfolio -> Portfolio : calculate_weights()
  Portfolio --> Actions : æƒé‡(å‡€): 11.02%
  
  Actions -> Signals : check_tactical_signals()
  
  alt è§¦å‘æˆ˜æœ¯ä¿¡å·
    Signals -> Signals : åˆ¤å®šï¼šåŸºäºŽæ˜¨å¤œæ”¶ç›˜æ•°æ®
    Signals --> Actions : ä¿¡å·ï¼šå‡ä»“ 100å…ƒ
    
    Actions -> Discord : æŽ¨é€æ™¨é—´æé†’
    note right
      **ðŸ“Š QDII æˆ˜æœ¯æé†’ï¼ˆæ˜¨å¤œæ”¶ç›˜ï¼‰**
      
      å¤©å¼˜çº³æ–¯è¾¾å…‹100(018043)
      â€¢ æ˜¨å¤œæ”¶ç›˜ï¼š1.8424
      â€¢ è¶…é¢æ”¶ç›Šï¼š18.5%ï¼ˆè§¦å‘å‡ä»“ï¼‰
      â€¢ å»ºè®®å‡ç ï¼š100å…ƒ
      
      **14:40 å°†å‘é€å¤æ ¸æé†’**
    end note
    
  end
  
  == 14:40 å¤æ ¸æé†’ ==
  
  Actions -> Actions : 14:40 CST å®šæ—¶è§¦å‘
  Actions -> Discord : æŽ¨é€å¤æ ¸ç¡®è®¤
  note right
    **âš ï¸ QDII å¤æ ¸æé†’**
    
    å¤©å¼˜çº³æ–¯è¾¾å…‹100(018043)
    â€¢ æˆªæ­¢æ—¶é—´ï¼š**15:00**
    â€¢ æˆäº¤ä»·ï¼šæŒ‰ä»Šæ™šæ”¶ç›˜å‡€å€¼ï¼ˆTæ—¥æœªçŸ¥ä»·ï¼‰
    â€¢ ç¡®è®¤æ—¶é—´ï¼šé¢„è®¡ **T+2**ï¼ˆé‡å¢ƒå¤–èŠ‚å‡æ—¥é¡ºå»¶ï¼‰
    â€¢ âš ï¸ é£Žé™©ï¼šä»Šæ™šè‹¥åå‘æ³¢åŠ¨ï¼Œæˆäº¤ä»·å°†åç¦»
    
    **å›žå¤ âœ… ç¡®è®¤æ‰§è¡Œ | âŒ å–æ¶ˆ**
  end note
  
  User -> Bot : å›žå¤ "âœ…"
  Bot -> Bot : LLMè§£æž + å‡½æ•°è°ƒç”¨
  Bot -> DB : å†™å…¥äº¤æ˜“ï¼ˆfund_type=QDIIï¼‰
  Bot -> Discord : âœ… å·²è®°å½•ï¼Œç­‰å¾… T+2 ç¡®è®¤
  
end

' ============================================================
' ç¡®è®¤è½®è¯¢æµç¨‹
' ============================================================

group ç¡®è®¤è½®è¯¢æµç¨‹ï¼ˆ10:30 / 18:30ï¼‰
  
  Actions -> Actions : 10:30 æˆ– 18:30 CST
  Actions -> Portfolio : éåŽ† pending äº¤æ˜“
  
  loop æ¯ç¬”å¾…ç¡®è®¤äº¤æ˜“
    Portfolio -> API : get_latest_nav(fund_code)
    API --> Portfolio : å‡€å€¼ + å‡€å€¼æ—¥æœŸ
    
    alt å‡€å€¼æ—¥æœŸ >= expected_confirm_date
      Portfolio -> DB : å›žå¡« shares, status=confirmed, nav_kind=å‡€
      Portfolio -> Discord : âœ… {fund_code} å·²ç¡®è®¤ {shares} ä»½
    else å°šæœªç¡®è®¤
      Portfolio --> Actions : è·³è¿‡ï¼Œç­‰å¾…ä¸‹æ¬¡è½®è¯¢
    end
  end
  
end

@enduml

