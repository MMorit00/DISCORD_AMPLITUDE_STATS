# Portfolio Report - 总体规划指南

> 投资组合自动化系统的完整规划与实施路线图

## 📋 目录

1. [项目目标](#项目目标)
2. [系统架构](#系统架构)
3. [实施路线图](#实施路线图)
4. [技术决策](#技术决策)
5. [风险与约束](#风险与约束)

---

## 🎯 项目目标

### 核心诉求
作为程序员，发挥技术优势，通过自动化解决投资管理中的痛点：
- ✅ **解放双手**：支付宝自动定投，无需每日手动操作
- ✅ **数据驱动**：自动抓取净值、计算权重、分析偏离
- ✅ **低频决策**：仅在关键阈值触发时提示，避免频繁骚扰
- ✅ **自然交互**：用中文对话修正数据，无需手动编辑文件
- ✅ **自动汇报**：日/周/月/半年/年自动推送到 Discord

### 设计原则
1. **少操心**：自动化一切可自动化的事情
2. **低频率**：信号冷却机制，避免高频交易
3. **可追溯**：所有操作记录在 Git，可回溯
4. **易理解**：清晰的架构图和文档

---

## 🏗️ 系统架构

### 分层设计

```
┌─────────────────────────────────────────┐
│          Discord 用户界面                │
│  • 自然语言交互（TODO）                   │
│  • 定时报告接收（TODO）                   │
└──────────────┬──────────────────────────┘
               │
      ┌────────┴────────┐
      │                 │
┌─────▼─────┐   ┌──────▼──────┐
│ Discord   │   │  GitHub     │
│ Bot       │   │  Actions    │
│ (Render)  │   │  (定时)     │
│ TODO      │   │  TODO       │
└─────┬─────┘   └──────┬──────┘
      │                │
      └────────┬────────┘
               │
┌──────────────▼──────────────────────┐
│        核心业务层（已实现 ✅）        │
│  • TradingCalendar (340行)          │
│  • Portfolio (361行)                │
│  • EastMoneyAPI (376行)             │
└──────────────┬──────────────────────┘
               │
┌──────────────▼──────────────────────┐
│          数据层                      │
│  • transactions.csv                 │
│  • holdings.json                    │
│  • state.json (TODO)                │
│  • config.yaml                      │
└─────────────────────────────────────┘
```

### 职责划分

| 组件 | 职责 | 运行方式 | 状态 |
|------|------|----------|------|
| **支付宝** | 执行定投（每日各100元） | 自动 | ✅ 配置完成 |
| **EastMoneyAPI** | 抓取净值/估值 | 被动调用 | ✅ 已实现 |
| **Portfolio** | 计算持仓/权重 | 被动调用 | ✅ 已实现 |
| **Signals** | 生成再平衡/战术信号 | 被动调用 | 🚧 TODO |
| **ReportBuilder** | 生成日/周/月报告 | 被动调用 | 🚧 TODO |
| **GitHub Actions** | 定时触发报告与轮询 | Cron | 🚧 TODO |
| **Discord Bot** | 监听消息、执行命令 | 常驻 | 🚧 TODO |
| **GitHubSync** | 幂等写入交易数据 | 被动调用 | 🚧 TODO |

---

## 🗺️ 实施路线图

### Phase 1: 数据基础层 ✅（已完成）

**目标：** 建立可靠的数据采集与计算能力

- [x] **Step 1.1**: 创建项目结构与配置文件
  - 配置：目标权重、基金映射、阈值
  - 数据模板：transactions.csv、holdings.json、state.json
  - Git 仓库整合

- [x] **Step 1.2**: 实现交易日历
  - 15:00 cutoff 判定
  - CN/US 交易日判定
  - T+N 确认日推演
  - **测试：** ✅ 全部通过

- [x] **Step 1.3**: 实现数据抓取
  - 东方财富 API 封装
  - 净值/估值智能获取
  - 本地缓存机制
  - **测试：** ✅ 真实数据验证

- [x] **Step 1.4**: 实现持仓管理
  - 从交易台账构建持仓
  - 估/净并行计算
  - 权重与偏离分析
  - **测试：** ✅ 样例数据验证

**成果：** ~1,600 行核心代码，完整测试覆盖

---

### Phase 2: 信号与指标层 🚧（进行中）

**目标：** 实现再平衡与战术决策能力

- [ ] **Step 2.1**: 实现收益指标计算（`core/metrics.py`）
  - 区间收益率
  - XIRR 计算（现金流法）
  - 最大回撤
  - 90日高点与回撤
  - **预计：** ~150 行

- [ ] **Step 2.2**: 实现信号引擎（`core/signals.py`）
  - 再平衡信号（轻度/强制）
  - 战术信号（加仓/减仓）
  - 冷却机制（60/90/30 天）
  - 信号优先级与冲突处理
  - **预计：** ~200 行

- [ ] **Step 2.3**: 实现确认轮询器（`core/confirm.py`）
  - 10:30/18:30 定时检查
  - 净值/份额自动回填
  - Discord 轻提醒
  - **预计：** ~150 行

**预计成果：** +500 行代码

---

### Phase 3: 报告与调度层 🚧（待开始）

**目标：** 自动化报告生成与定时推送

- [ ] **Step 3.1**: 实现报告生成器（`report/builder.py`）
  - 日报模板（08:30）
  - 周报模板（周一 08:45）
  - 月报模板（次一交易日 09:45）
  - 半年/年报模板
  - **预计：** ~250 行

- [ ] **Step 3.2**: 实现 CLI 入口（`main.py`）
  - 命令行参数解析（`--freq daily|weekly|monthly`）
  - 交易日感知与跳过
  - 次一交易日判定
  - **预计：** ~100 行

- [ ] **Step 3.3**: 创建 GitHub Actions 工作流
  - `portfolio-daily.yml`
  - `portfolio-weekly.yml`
  - `portfolio-monthly.yml`
  - `portfolio-confirm-cron.yml`
  - **预计：** ~200 行 YAML

**预计成果：** +550 行代码

---

### Phase 4: Discord Bot 交互层 🚧（待开始）

**目标：** 自然语言交互与数据修正

- [ ] **Step 4.1**: 实现 LLM 函数调用路由（`discord-bot/llm_handler.py`）
  - Qwen-Flash（主）
  - GLM-Flash/Doubao（兜底）
  - Function calling 封装
  - **预计：** ~200 行

- [ ] **Step 4.2**: 实现 GitHub 幂等写入（`discord-bot/github_sync.py`）
  - If-Match 并发控制
  - 事务 ID 幂等性
  - 软删除策略
  - 自动 commit
  - **预计：** ~150 行

- [ ] **Step 4.3**: 实现 Discord Bot 主程序（`discord-bot/bot.py`）
  - Gateway 监听
  - 消息解析与路由
  - 工具函数执行
  - 权限校验
  - **预计：** ~250 行

- [ ] **Step 4.4**: 定义工具函数（`discord-bot/functions.py`）
  - `skip_investment()` - 跳过定投
  - `update_position()` - 调整持仓
  - `confirm_shares()` - 确认份额
  - `query_status()` - 查询持仓
  - `delete_transaction()` - 删除记录
  - **预计：** ~200 行

- [ ] **Step 4.5**: Render 部署配置
  - `render.yaml`
  - `.env.example`
  - 部署文档
  - **预计：** ~100 行

**预计成果：** +900 行代码

---

### Phase 5: 文档与完善 🚧（待开始）

**目标：** 完善文档和用户体验

- [ ] **Step 5.1**: 补充部署文档
  - Discord Bot 注册流程
  - Render 部署步骤
  - GitHub Actions 配置
  - 环境变量说明

- [ ] **Step 5.2**: 完善 README 与示例
  - 快速开始指南
  - 常见问题（FAQ）
  - 故障排查

- [ ] **Step 5.3**: 优化与测试
  - 端到端测试
  - 错误处理完善
  - 性能优化

---

## 💡 技术决策

### 1. 为什么用 Render Background Worker？

**需求：** Discord Bot 需要 24/7 在线监听 Gateway（WebSocket）

**选择对比：**
| 平台 | 常驻支持 | 免费额度 | 网络延迟 | 结论 |
|------|----------|----------|----------|------|
| GitHub Actions | ❌ 最多6小时 | ✅ 充足 | 中等 | ❌ 不适合 |
| Vercel | ❌ 无状态函数 | ✅ 充足 | 低 | ❌ 不适合 |
| Render | ✅ Background Worker | ✅ 512MB免费 | 低（选新加坡） | ✅ **最佳** |
| Railway | ✅ 支持 | ⚠️ 试用额度 | 低 | ⚠️ 需付费 |

**结论：** Render Background Worker + GitHub Actions（定时任务）

### 2. 为什么用 Qwen/GLM/豆包而不是 OpenAI？

**需求：** 低延迟、低成本、函数调用支持

**选择对比：**
| 模型 | 函数调用 | 价格（¥/百万token） | 新加坡端点 | 延迟 |
|------|----------|---------------------|------------|------|
| GPT-4o-mini | ✅ | ~1.2 (input) | ❌ 美国 | 高 |
| Qwen-Flash | ✅ | ~0.2 (估算) | ✅ 有 | **低** |
| GLM-4-Flash | ✅ | ~0.1 | ❌ 国内 | 中 |
| Doubao | ✅ | ~0.8 | ❌ 国内 | 中 |

**结论：** Qwen（新加坡端点）主用 + GLM/豆包兜底

### 3. 为什么估/净并行？

**问题：** QDII 净值有 T+1/T+2 滞后，盘中无法获取最新净值

**解决方案：** 双轨道计算
- **净值口径**：用于正式决策（再平衡/战术信号）
- **估值口径**：用于盘中参考（日报/实时查询）

**实现：** Position 类同时维护 `nav` 和 `estimate_value`

### 4. 为什么用 15:00 Cutoff？

**支付宝规则：**
- 15:00 前提交 → T 日净值成交
- 15:00 后提交 → T+1 日净值成交

**实现：** `TradingCalendar.check_cutoff()` 精确判定

---

## 📊 数据结构设计

### transactions.csv（交易台账）

**核心字段：**
```csv
tx_id,date,fund_code,amount,shares,type,status
tx001,2025-10-20,000051,6800,3850.17,buy,confirmed
```

**扩展字段（支付宝/QDII 口径）：**
- `cutoff_flag`: pre15/post15（15:00 分界）
- `trade_day_cn`: T 日（中国交易日）
- `expected_nav_date`: 预计净值日（A股=T，QDII=T+1）
- `expected_confirm_date`: 预计确认日（A股=T+1，QDII=T+2）
- `confirm_date`: 实际确认日（回填）
- `nav_kind`: 估/净
- `status`: pending/confirmed/skipped

**设计理由：**
1. 支持回溯分析（哪些交易是 15:00 后？）
2. 支持确认轮询（自动回填 `confirm_date`）
3. 支持软删除（`type=skip`，保留历史）

### holdings.json（持仓快照）

**结构：**
```json
{
  "generated_at": "2025-10-28T16:00:00",
  "total_value_net": 8144.31,
  "total_value_est": 8200.15,
  "weights_net": {
    "US_QDII": 0.1102,
    "CSI300": 0.8342,
    "CGB_3_5Y": 0.0557
  },
  "weights_est": { ... },
  "positions": { ... }
}
```

**用途：**
- 报告生成时读取
- 历史快照对比
- 避免重复计算

### state.json（信号状态）

**结构（TODO）：**
```json
{
  "last_signals": {
    "US_QDII": {
      "type": "rebalance_strong",
      "triggered_at": "2025-10-28",
      "cooldown_until": "2026-01-26"
    }
  },
  "signal_history": [ ... ],
  "last_rebalance": "2025-07-01"
}
```

---

## 🚀 实施路线图

### 里程碑 1: 数据基础层 ✅（已完成）

**时间：** 2025-10-28
**代码量：** ~1,600 行
**Git 提交：** 7 个

| 任务 | 状态 | 文件 | 行数 |
|------|------|------|------|
| 项目结构与配置 | ✅ | config.yaml | 142 |
| 交易日历 | ✅ | core/trading_calendar.py | 340 |
| 数据抓取 | ✅ | sources/eastmoney.py | 376 |
| 持仓管理 | ✅ | core/portfolio.py | 361 |
| 配置加载 | ✅ | utils/config_loader.py | 93 |
| Discord 推送 | ✅ | utils/discord_webhook.py | 69 |
| 测试文件 | ✅ | core/test_*.py | ~330 |

**验证：** 所有测试通过 ✅

---

### 里程碑 2: 信号与指标层 🚧（下一步）

**预计时间：** 1-2 天
**预计代码量：** ~500 行

- [ ] **Task 2.1**: 收益指标计算（`core/metrics.py`）
  - XIRR/IRR
  - 最大回撤
  - 90日高点/回撤
  - **优先级：** 高
  - **依赖：** Portfolio

- [ ] **Task 2.2**: 信号引擎（`core/signals.py`）
  - 再平衡信号（轻度/强制）
  - 战术信号（加仓/减仓）
  - 冷却机制
  - **优先级：** 高
  - **依赖：** Portfolio, Metrics

- [ ] **Task 2.3**: 确认轮询器（`core/confirm.py`）
  - 10:30/18:30 定时检查
  - 自动回填确认数据
  - Discord 通知
  - **优先级：** 高
  - **依赖：** Portfolio

**里程碑验证：**
- [ ] 信号生成测试
- [ ] 冷却机制测试
- [ ] 确认回填测试

---

### 里程碑 3: 报告与自动化层 🚧（待开始）

**预计时间：** 2-3 天
**预计代码量：** ~600 行

- [ ] **Task 3.1**: 报告生成器（`report/builder.py`）
  - 日报模板
  - 周报模板
  - 月报模板
  - 半年/年报模板
  - **优先级：** 高
  - **依赖：** Portfolio, Signals

- [ ] **Task 3.2**: CLI 入口（`main.py`）
  - 参数解析
  - 交易日判定
  - 流程编排
  - **优先级：** 高
  - **依赖：** ReportBuilder

- [ ] **Task 3.3**: GitHub Actions 工作流
  - 日报/周报/月报 workflows
  - 确认轮询 workflow
  - 环境变量配置
  - **优先级：** 中
  - **依赖：** CLI

**里程碑验证：**
- [ ] 手动触发报告测试
- [ ] Actions 定时触发测试
- [ ] Discord 推送测试

---

### 里程碑 4: Discord Bot 交互层 🚧（待开始）

**预计时间：** 3-4 天
**预计代码量：** ~900 行

- [ ] **Task 4.1**: LLM 函数调用路由（`discord-bot/llm_handler.py`）
  - Qwen/GLM/豆包路由
  - Function calling 封装
  - 降级策略
  - **优先级：** 中
  - **依赖：** 无

- [ ] **Task 4.2**: GitHub 幂等写入（`discord-bot/github_sync.py`）
  - If-Match 并发控制
  - 事务 ID 幂等
  - 软删除
  - **优先级：** 中
  - **依赖：** 无

- [ ] **Task 4.3**: 工具函数定义（`discord-bot/functions.py`）
  - skip_investment
  - update_position
  - confirm_shares
  - query_status
  - delete_transaction
  - **优先级：** 中
  - **依赖：** Portfolio

- [ ] **Task 4.4**: Bot 主程序（`discord-bot/bot.py`）
  - Gateway 监听
  - 消息路由
  - 权限校验
  - 错误处理
  - **优先级：** 中
  - **依赖：** LLMHandler, GitHubSync, Functions

- [ ] **Task 4.5**: Render 部署
  - render.yaml
  - 环境变量配置
  - 健康检查
  - **优先级：** 中
  - **依赖：** Bot

**里程碑验证：**
- [ ] 本地 Bot 测试
- [ ] LLM 函数调用测试
- [ ] GitHub 写入测试
- [ ] Render 部署测试

---

### 里程碑 5: 文档与完善 🚧（最后）

**预计时间：** 1-2 天

- [ ] **Task 5.1**: 部署文档
  - Discord Bot 注册流程
  - Render 部署步骤
  - GitHub Actions 配置
  - **优先级：** 低

- [ ] **Task 5.2**: 用户文档
  - 快速开始
  - FAQ
  - 故障排查
  - **优先级：** 低

- [ ] **Task 5.3**: 优化与测试
  - 端到端测试
  - 性能优化
  - 错误处理完善
  - **优先级：** 低

---

## 🎯 关键时间节点

### 信号推送时间（未知价原则）

#### A股信号（000051, 001512）
```
09:45 - 初筛（可选）
  ↓
14:40 - 最终确认提醒
  ↓
15:00 - 交易截止
```

#### QDII 信号（018043, 018044, 019305）
```
07:30 - 昨夜收盘信号推送
  ↓
14:40 - 复核提醒（今晚未知价）
  ↓
15:00 - 交易截止（T+2 确认）
```

### 定时报告时间

```
08:30 - 日报（包含前一日总结 + 今日计划）
周一 08:45 - 周报
月初次一交易日 09:45 - 月报
1月1日/7月1日次一交易日 10:00 - 半年/年报
```

### 确认轮询时间

```
10:30 - 上午轮询（QDII 净值通常此时公告）
18:30 - 下午补充轮询
```

---

## ⚠️ 风险与约束

### 数据风险
- ⚠️ **QDII 净值滞后**：T+1/T+2，盘中仅有估值
- ⚠️ **第三方 API 依赖**：天天基金/东方财富接口可能变更
- ⚠️ **节假日判定**：美股假日库需定期更新

**缓解措施：**
- 估/净并行，明确标注数据类型
- 多 API 降级策略
- 节假日库年度更新

### 交易风险
- ⚠️ **未知价原则**：15:00 前确认，成交价未知
- ⚠️ **<7天赎回惩罚**：1.5% 费率
- ⚠️ **信号偏差**：QDII 隔夜跳空风险

**缓解措施：**
- 信号提示包含风险说明
- 自动检测持有天数
- QDII 信号标注"隔夜风险"

### 技术风险
- ⚠️ **Render 免费层限制**：512MB 内存
- ⚠️ **LLM API 成本**：每月约 $1-5
- ⚠️ **Discord 速率限制**：每秒 5 条消息

**缓解措施：**
- 内存优化（按需加载）
- LLM 缓存与路由
- 消息队列与合并

---

## 📈 预期成果

### 最终系统能力

1. **自动化定投**：无需手动操作，支付宝执行 ✅
2. **智能提醒**：低频、精准的再平衡与战术建议
3. **自然交互**：Discord 中文对话修正数据
4. **定时汇报**：日/周/月/半年/年自动推送
5. **数据可追溯**：Git 历史 + CSV 台账

### 预期代码量

| 阶段 | 代码量 | 状态 |
|------|--------|------|
| Phase 1: 数据基础 | ~1,600 行 | ✅ 已完成 |
| Phase 2: 信号指标 | ~500 行 | 🚧 进行中 |
| Phase 3: 报告调度 | ~600 行 | 🚧 待开始 |
| Phase 4: Bot 交互 | ~900 行 | 🚧 待开始 |
| Phase 5: 文档完善 | - | 🚧 待开始 |
| **总计** | **~3,600 行** | **36% 完成** |

### 预期运行成本

| 项目 | 成本 | 说明 |
|------|------|------|
| Render Free Instance | $0 | 512MB 内存限制 |
| GitHub Actions | $0 | 免费额度充足 |
| LLM API (Qwen/GLM) | ~$1-5/月 | 按实际使用量 |
| **总计** | **~$1-5/月** | 几乎免费 |

---

## 🔗 相关链接

- **仓库地址**: https://github.com/MMorit00/DISCORD_AMPLITUDE_STATS
- **架构图**: [Flow/current-architecture.puml](Flow/current-architecture.puml)
- **PlantUML 指南**: [Prompt/PlantUML-Guide.md](Prompt/PlantUML-Guide.md)

---

## 📅 版本历史

### v0.1（当前）- 2025-10-28
- ✅ 交易日历与 15:00 cutoff
- ✅ 净值/估值抓取与缓存
- ✅ 持仓管理与权重计算
- ✅ 估/净并行架构
- ✅ 配置管理与工具类

### v0.2（计划中）
- 🚧 收益指标计算
- 🚧 信号引擎
- 🚧 确认轮询器
- 🚧 报告生成器

### v0.3（计划中）
- 🚧 Discord Bot
- 🚧 LLM 交互
- 🚧 GitHub Actions

### v1.0（目标）
- 🎯 完整的自动化系统
- 🎯 生产环境部署
- 🎯 完善的文档

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

最后更新：2025-10-28

